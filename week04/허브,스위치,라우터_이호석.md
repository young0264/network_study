# 📌 3장: 케이블의 앞은 LAN 기기였다.

![image](https://github.com/young0264/network_study/assets/66772624/b3c801b4-a5ec-49c9-bffe-9b2aabecdfb2)

<br><br>

## ✅ 01 케이블과 리피터, 허브 속에 신호가 흘러간다.

### 1. 하나하나의 패킷이 독립된 것으로 동작한다

![image](https://github.com/young0264/network_study/assets/66772624/79a36a9c-028e-48e6-a2a1-20888e580efe)


- 컴퓨터에서 송신된 패킷은 허브, 라우터라는 중계 장치에 의해 중계되어 목적지를 향해 진행함
- 패킷의 헤더에 기록된 제어 정보와 중계 장치의 내부에 있는 중계 대상을 등록한 표로 목적지를 판단하고 목적지에 가까워지도록 하면서 패킷을 중계함
    - 제어 정보: MAC 헤더, IP 헤더
- 하위 프로토콜의 제어 정보는 패킷을 운반하는 동작에 영향을 주지 않음 → 그저 데이터로 생각
- 클라이언트 PC → 리피터 허브 → 스위칭 허브 → 라우터 → 인터넷 접속용 라우터 → 인터넷

<br>

### 2. LAN 케이블은 신호를 약화시키지 않는 것이 핵심이다.

3장은 LAN 어댑터에서 패킷이 송신되어 케이블로 나가는 부분부터 시작됩니다.

- LAN 어댑터의 PHY(MAU) 회로에서 전기 신호로 형태를 바꾼 패킷은 RJ-45 커넥터를 통해 트위스트 페어 케이블에 들어갑니다.
- `LAN어댑터` → `LAN 어댑터의 PHY(MAU)회로` → `RJ-45 커넥터로 결선되어 있음` → `트위스트 페어 케이블(단순히 전기 신호가 흐름)` → `리피터 허브의 RJ-45` → `리피터 허브의 PHY(MAU)` → `리피터 회로`
- RJ-45 커넥터

![image](https://github.com/young0264/network_study/assets/66772624/f9d03f0d-3271-415f-b98c-1734a9c6bd3b)


- EIA-568B (줄여서 T568B) → 책의 정보 틀림
    
    ![image](https://github.com/young0264/network_study/assets/66772624/e36dd420-415c-4fa1-8e8f-003602155c23)

    

송출 신호는 원래 모습으로 리피터 허브에 도착하지 않고 신호가 많이 약해진 상태로 도착합니다.
신호가 약해지는 원인으로 여러가지가 존재합니다.

1. 주파수가 높을수로 에너지가 떨어지는 비율 높음
2. 잡음(내부, 외부)의 영향으로 신호가 뭉개지고 신호가 약해짐

<br>

### 3. ‘꼼’은 잡음을 방지하기 위한 방법이다.

LAN 케이블로 사용하는 트위스트 페어 케이블에는 잡음의 영향을 억제하기 위해 두 가닥의 신호선을 마주 꼬아서 사용합니다.

![image](https://github.com/young0264/network_study/assets/66772624/0f69ecfd-3497-4ef0-81f4-9f6681d8471c)


- **잡음의 원인은 전자파**
    
    잡음은 케이블 주위에서 발생하는 전자파에 의해 발생하는것이 가장 큰 원인입니다.
    
    전자파가 흐르면 전류가 발생하는데 신호의 방향과 다른 전류때문에 신호선에 흐르는 전류가 영향을 받게 됩니다. 이로인해 파형의 변형도 발생합니다.
    

- **전자파는 크게 두 종류가 존재**
    1. **외부에서 발생하는 전자파**
        
        모터, 형광등, CRT 모니터와 같은 기기에서 누설되는 전자파 입니다. 케이블 밖에서 오는 것으로 위 사진 처럼 선을 `꼼`으로써 막을 수 있습니다.
        
    2. **케이블 안의 인접한 신호선에서 누설되는 전자파**
        
        신호선은 전류가 흐르므로 당연히 전자파가 발생합니다.
        
        하지만 신호선을 꼬는 간격을 다르게 해 어떤 곳은 플러스 신호가 강하게, 다른곳은 마이너스 신호를 강하게 잡음을 발생시켜 서로 상쇄시키고 균형을 잡아 잡음을 줄입니다.
        
        추가적으로 신호선 사이의 거리를 유지시키는 구분판이나 전자파 차단을 위한 차폐를 하기도 합니다.
        
    
<br>

### 리피터 허브는 연결되어 있는 전체 케이블에 신호를 송신한다

신호가 리피터 허브에 도달하면 LAN 전체에 신호가 흩어집니다. 
리피터 허브는 전체에 패킷의 신호를 뿌리고 수신처 MAC주소에 해당되는 기기만 패킷을 수신한다는 원리를 그대로 실현합니다.

![image](https://github.com/young0264/network_study/assets/66772624/4bddde05-45f7-4e9a-8864-b3f542618613)


- 위 사진과 같이 LAN 어댑터와 RJ-45를 직접 접속하듯 리피터 허브의 RJ-45를 PHY(MAU)회로에 직접 연결하면 신호를 제대로 수신하지 못합니다.
- 따라서 송신 단자에서 보낸 신호는 수신 단자로 받도록 해야 합니다.
    
    ![image](https://github.com/young0264/network_study/assets/66772624/b7386e17-8021-4a7c-ae3e-00fb033de468)

    
- 그러기 위해서는 각 커넥터에서 이를 고려해야 하는데 이런 문제를 해결해주는 MDI와 MDI-X 종류의 케이블이 존재합니다.
    
    ![image](https://github.com/young0264/network_study/assets/66772624/7a1e89dc-3075-4328-94c6-71226a8db10a)

    
    위와 같이 MDI와 MDI-X를 연결하는것은 송신 - 수신 관계가 잘 이어지므로 문제가 없지만
    
    ![image](https://github.com/young0264/network_study/assets/66772624/71930bb0-971e-405e-b6b2-b47ba007118e)

    
    다음과 같이 MDI - MDI (혹은 MDI-X, MDI-X)끼리 이어주는 경우에는 `송신 - 송신`, `수신-수신`끼리 이어지므로 이를 방지하기 위해 `크로스 케이블`을 이용해야 합니다.
    
    최근에는 이런 혼선을 방지하기 위한 auto MDIX가 있는데 이는 다이렉트 케이블과 크로스 케이블을 자동으로 판단하는 기능입니다.
    

- **리피터 허브안 리피터 회로의 역할**
    - 리피터 회로에서 PHY(MAU) 회로의 수신부에 도달한 신호는 여기서부터 `리피터 회로`에 포함됩니다.
    - 리피터 회로의 기본 동작은 들어오는 신호를 리피터 허브의 커넥터 부분에 뿌리는 동작입니다. 즉, 들어온 신호를 그대로 커넥터 부분에 송출합니다.
    - 이후 신호는 모든 커넥터에 나가고 → 리피터 허브에 접속한 전체 기기에 도달 → 신호를 수신한 기기는 MAC헤더의 수신처 MAC주소와 자신의 주소를 비교 → 맞다면 수신하고 아니라면 무시함
    - 결국 기본 동작은 오는 신호를 그대로 뿌리는 것입니다. 따라서 잡음의 영향을 받아 변형되고 변환된것 같은 신호도 그대로 흘립니다.
    - 어차피 FCS를 검사하는 곳에서 검사 이후 잘못된 패킷은 폐기하고 수신응답(ACK)을 돌려주지 않으므로 프로토콜 스택의 TCP 담당 부분이 다시 패킷을 보내주기에 괜찮습니다.
    
<br><br>

## ✅ 02 스위칭 허브의 패킷 중계 동작

### 1. 스위칭 허브는 주소 테이블로 중계한다

스위칭 허브는 이더넷의 패킷을 그대로 목적지를 향해 중계하도록 만들어져 있습니다.

| MAC 주소 | 포트(TCP 포트아님) | 제어 정보 |
| --- | --- | --- |
| 00-60-97-A5-43-3C | 2 | ... |
| 00-00-C0-16-AE-FD | 7 | ... |
| 00-02-B3-1C-9C-F9 | 8 | ... |
| ... | ... | ... |

> MAC 주소와 포트 번호를 등록한 테이블, 패킷을 수신할 때 수신 포트와 송신처 주소가 함께 등록됩니다. 이를통해 해당 주소가 어느 포트에 접속되어 있는지 판단할 수 있습니다.
> 

**스위칭 허브의 동작은 다음과 같습니다.**
(신호가 커넥터에 도착해 PHY(MAU)회로에서 수신되는 부분 까지는 리피터 허브와 동일함)

1. 커넥터와 PHY(MAU) 회로는 MDI-X로 접속되어 있고, 트위스트 페어 케이블에서 신호가 들어오면 이것이 PHY(MAU) 회로의 수신 부분에 들어감
2. PHY(MAU)회로에서 케이블을 흐르는 신호의 형식을 공통의 신호 형식으로 변환하고 신호가 MAC 회로로 전달됨
3. MAC 회로에서 디지털 데이터로 변환하고 패킷의 맨 끝에 있는 FCS를 대조해 오류의 유무 검사 (오류라면 패킷 버림)
    - 여러개의 스위칭 허브의 커넥터 안쪽은 LAN 어댑터와 같은 회로
    - 커넥터와 안쪽 회로를 **포트 라고 부름**
    - 스위칭 허브의 포트는 수신처 MAC 주소를 검사하지 않고 모든 패킷을 수신하고 버퍼 메모리에 저장함, 따라서 포트에는 MAC 주소가 할당되어 있지 않음
4. 버퍼 메모리에 저장한 후 MAC 주소표에서수신처 MAC 주소와 일치하는것을 찾습니다. 이를 사용해 수신 패킷을 어떤 포트에서 송신할지 결정합니다.
5. 송신측 포트에 패킷을 운반하면  MAC회로와 PHY(MAU)회로가 송신 동작을 실행하고 케이블에 신호가 흘러감

**스위치 회로의 구조**

- 신호선이 격자 모양으로 배치되고, 교점마다 스위치가 있습니다. 이는 전자적으로 개폐를 제어할 수 있습니다.
- 전자적 개폐를 통해 신호가 흐르는 대상을 제어합니다.
- 입력측은 수신측 포트, 출력측은 송신측 포트에 각각 접속 되어 있음

<br>

### 2. MAC 주소 테이블을 등록 및 갱신한다

스위칭 허브는 패킷을 중계할 때 MAC 주소표의 내용을 갱신하는 동작도 합니다.

갱신 동작은 두 종류가 존재합니다.

1. 패킷을 수신했을때 송신처 MAC 주소를 조사하고 이것을 수신한 입력 포트 번호와 하나의 세트로 MAC 주소표에 등록하는 작업
2. MAC 주소표에 등록한 정보는 그대로 두지 않고 일정 시간이 경과하면 삭제합니다.
    - 스위칭 허브에 연결한 기기를 제거하는 경우, 사용하지 않는 MAC 주소 및 포트가 존재하게 됨

1, 2와 같은 동작 덕분에 스위칭 허브에 수동으로 MAC 주소를 등록, 삭제할 필요가 없습니다.

<br>

### 3. 예외적인 동작

1. 주소표에 등록되어 있는 송신처 포트가 패킷을 수신한 포트와 동일할때는 해당 패킷을 폐기함
    - 스위칭 허브와 리피터 허브가 접속되어 있을때, 스위칭 허브 → 리피터 허브로 패킷을 전송하면 리피터 허브는 다시 연결되어 있는 모든 기기에 패킷을 반송합니다. 이때 스위칭 허브에 다시 동일한 패킷을 보내게 됨 → 폐기
2. MAC 주소표에 수신처 MAC 주소와 일치하는 주소가 등록되어 있지 않음은 경우엔 어느 포트에서 송신할지 모르므로 수신 포트를 제외한 모든 전체 포트로 패킷을 송신합니다.
3. 수신처 MAC 주소가 브로트캐스트 주소인 경우에도 수신 포트를 제외하고 모든 포트에서 패킷을 송신합니다.

<br>

### 4. 전이중 모드에서 송신과 수신을 동시에 실행한다

전이중 모드는 송신과 수신을 동시에 실행할 수 있는 모드를 말합니다.

![image](https://github.com/young0264/network_study/assets/66772624/6c7e54ba-0709-4a85-9126-47d55770affa)


- 위와 같은 트웨스트 페어 케이블 덕분에 **신호선은 송신용, 수신용으로 나뉩니다.** 따라서 송,수신 신호가 서로 충돌하지 않습니다.
- 더불어 스위칭 허브의 포트, PHY(MAU), MAC 회로의 내부도 송신과 수신이 나뉩니다.

위와 같은 특징으로 송수신을 동시에 해도될것 같지만 이더넷의 규칙 상 신호가 흐를때는 끝나기를 기다리고 다음 송신 혹은 수신을 진행하는 규칙이 있습니다.

이런 규칙을 개정하여 신호가 흐르고 있어도 상관하지 않고 송신해도 좋다는 동작 모드가 추가됐습니다.

- **해당 동작 모드가 동작할때는 신호의 충돌을 검출하는 회로를 무효화 시킵니다.**
- 위와 같은 동작을 `전이중 모드`라고 부릅니다.

<br>

### 5. 최적의 전송 속도로 보내는 자동 조정

전이중 모드, 반이중 모드의 허브가 연결되어 있거나 서로 다른 전송 속도를 가진 기기들이 연결되어 있을 경우 **자동 조정**을 통해 이를 맞춰갑니다.

이더넷은 데이터가 흐르고 있지 않아도 **링크 펄**스라는 신호를 흘립니다. 이것을 통해 상대가 올바른 작동, 케이블 단선 여부 등을 확인합니다. (MAC 회로, 버퍼 메모리, 버스 신호선은 확인 불가)

- 이런 링크 펄스에 특정 패턴으로 펄스 신호를 송신하여 자신의 상황을 상대에게 전하며 자동 조정 기능을 합니다.
- 홀수 번째 펄스는 신호의 타이밍을 잡고, 짝수 펄스를 통해 패턴의 의미를 부여합니다.
- 가장 높은 우선순위부터 차례로 패턴을 맞춰가면서 최적의 전송 동작을 자동으로 조정합니다. (219page 그림 참조)

<br>

### 6. 스위칭 허브는 복수의 중계 동작을 동시에 실행한다

N개의 포트가 존재하는 스위칭 허브에서 2개의 포트에 패킷이 흐른다면 N - 2개의 포트는 빈 상태가 됩니다.
여기에 별도에 패킷을 흘릴 수 있고 이렇게 하여 동시에 여러개의 패킷을 중계할 수 있습니다.

기기 전체에서 중계할 수 있는 패킷의 수 : 스위칭 허브 > 리피터 허브

<br><br>

## ✅ 03 라우터의 패킷 중계 동작(여기서 말하는 포트와 TCP PORT는 다름)

### 1. 라우터의 기본

허브(리피터, 스위칭)를 경유한 패킷은 결국 라우터에 도착하고 다음 라우터로 중계되어야 합니다.

라우터 또한 중계 대상을 등록한 표(라우팅 테이블)을 보고 다음 중계지가 어딘지 판단합니다.

**라우터는 두 부분으로 구성됨**

1. `중계 부분`: 패킷의 중계 대상을 판단하는 동작을 담당(**IP 담당 부분**)
2. `포트 부분`: 패킷을 송수신하는 동작을 담당(**LAN 어댑터의 역할**)

또한 포트 부분에 여러 통신 기술의 하드웨어를 장착하면 다양한 통신 기술을 지원할 수 있습니다.

**간략한 라우터의 동작**

- 포트 부분에서 패킷을 수신할때 포트 부분의 통신 기술의 규칙을 따릅니다. (이더넷, 무선 LAN, 통신 회선 등 다양한 규칙 존재)
    - 포트 부분은 패킷의 송신처 또는 수신처가 될 수 있습니다.
    - 포트가 이더넷이라면 라우터의 포트에는 **MAC주소가 할당**됨 → 이더넷의 송신처 및 수신처가 될 수 있음
    - 또한 **IP 주소도 포트**에 할당됨 → 컴퓨터의 LAN 어댑터와 같음
- 해당 하드웨어에 의뢰해 패킷을 수신해옵니다.
- 중계 부분은 받은 IP 패킷에 기록되어 있는 수신처 IP 주소와 중계 대상을 등록한 표를 대조해 중계 대상을 판단합니다.
- 이후 중계 대상측 포트로 패킷을 옮기고 포트 부분의 하드웨어 규칙에 따라 패킷 송신 동작을 실행합니다.

> 위와 같은 특징으로인해 라우터의 포트 부분은 패킷을 중계할때는 수신처가 되고 패킷을 송신해야 할때는 송신처가 됩니다. 
(**스위칭 허브와의 차이점, 스위칭 허브는 들어온 패킷을 전송하기만 하고 자기 자신이 송신처, 수신처가 되진 않음**)
> 

<br>

### 2. 경로표에 등록된 정보

| 수신처 | 넷마스크 | 게이트웨이 | 인터페이스 | 메트릭 |
| --- | --- | --- | --- | --- |
| 10.10.1.0 | 255.255.255.0 | --- | e2 | 1 |
| 10.10.1.101 | 255.255.255.255 | --- | e2 | 1 |
| 192.168.1.0 | 255.255.255.0 | --- | e3 | 1 |
| 192.168.1.10 | 255.255.255.255 | --- | e3 | 1 |
| 0.0.0.0 | 0.0.0.0 | 192.0.2.1 | e1 | 1 |

라우터는 IP 헤더에 기재되어 있는 수신처 IP 주소로 중계 대상을 판단합니다.
취급하는 주소는 서로 다르므로 중계 대상의 주소를 등록하는 테이블의 내용도 다릅니다.

- 라우팅 테이블 구성
    - `수신처(목적지)`
        
        수신처의 정보가 들어있음, 등록되어 있는 IP 주소와 수신한 패킷의 수신치 IP 주소를 비교하여 특정 행에 해당되는지 판단함
        
        **라우터는 호스트 번호는 무시하고 네트워크 번호 부분만 조사합니다.**
        
    - `넷마스크`
        
        네트워크 번호 부분만 조사할때 넷마스크 항목을 참조함 (상위 몇비트까지 네트워크 번호에 해당되는지 판단하기 위해)
        
    - `인터페이스`
        
        라우터는 일반적으로 이더넷 인터페이스를 사용하여 동일한 네트워크의 다른 장치(예: eth0 또는 eth1)에 연결하고 직렬 인터페이스를 사용하여 외부 광역 네트워크(WAN)에 연결합니다. 라우팅 테이블에는 장치가 패킷을 다음 홉으로 전달할 때 사용해야 하는 인바운드 네트워크 인터페이스(발신 인터페이스라고도 함)가 나열되어 있습니다.
        
    - `게이트웨이`
        
        한 네트워크(segment)에서 다른 네트워크로 이동하기 위하여 거쳐야 하는 지점(**다른 언어를 사용하는 두 사람 사이에 통역사나 번역기**와 비슷하다고 볼 수 있습니다.)
        
        집 컴퓨터에서 인터넷에 접속하려는 경우 **집 -> 공유기 -> 인터넷 제공 회사 라우터 -> 인터넷망**와 같은 경로를 따라갑니다. 이 때, 공유기와 인터넷 제공 회사의 라우터는 이전의 단계에서 다음 단계로 넘어 갈 때의 게이트웨이 역할을 담당합니다. **인터넷에 접속하기 위하여는 수많은 게이트웨이를 거쳐야합니다.**
        
        출처: https://melonicedlatte.com/network/2020/04/28/201100.html
        
    - `메트릭`
        
        패킷이 목적지에 도착하기까지 통과해야 하는 라우터의 수
        

- **주소 집약**
    - 몇 개의 서브넷을 모아서 한 개의 서브넷으로 간주한 후 묶은 서브넷을 라우팅 테이블에 등록함

- **넷마스크 값이 255.255.255.255인 것의 의미**
    - 호스트 비트는 0개이고 32비트 모두 네트워크 번호가 됩니다.
    따라서 어떤 IP 주소와 AND 연산을 해도 해당 IP 값이 됩니다. 이 주소는 특별한 용도로 사용되며 주로 브로트캐스트 주소를 나타낼때 사용됩니다.

- 패킷을 중계할때는 경로표의 내용에 손대지 않음
    
    경로표에 경로를 등록하는 방법은 크게 두 가지로 분류됨
    
    1. 사람이 수동으로 경로 정보를 등록/갱신
    2. 라우팅 프로토콜을 이용해 라우터들끼리 경로 정보를 교환하고 라우터가 자체적으로 경로표에 등록함(RIP, OSPF, BGP 등) → 다익스트라

<br>

### 3. 라우터의 패킷 수신 동작

LAN 어댑터와 동일

라우터의 포트에는 MAC 주소가 할당되어 있고, 라우터 또한 자신의 주소에 해당하는 패킷만 수신하고 해당하지 않은 패킷을 폐기

<br>

### 4. 경로표를 검색하여 출력 포트를 발견한다

라우터의 패킷 수신 동작이 끝나면 MAC 헤더 폐기함
이후 다음과 같이 IP 헤더의 내용을 보고 패킷 중계 동작을 실행합니다.

1. 경로표에서 중계 대상을 조사함
2. 중계 대상을 조사할 때 가장 먼저 수신한 패킷의 수신처 IP 주소 및 경로표의 수신처(목적지) 항목을 조사하여 해당 행을 찾음 (네트워크 번호만 비교하여)
3. 이때 복수의 후보가 발견되는데 다음과 같은 우선순위로 고름
    - 네트워크 번호가 가장 긴 것이 높은 우선순위 → 적은 호스트를 갖고 있으므로 범위가 축소됨
    - 네트워크 번호가 동일하면 가장 작은 메트릭 값을 가진 행을 선택

3-1. 해당하는 행이 하나도 없다면 ICMP를 이용해 송신처에 이 사실을 통지합니다.

- 라우터가 접속한 인터넷의 규모는 헤아릴 수 없으므로, 무작정 패킷을 보낼 수 없음

<br>

### 5. 해당하는 경로가 없는 경우에 선택하는 기본 경로

넷마스크 값이 0.0.0.0이라면 어떤 IP와 비교해도 (0.0.0.0 AND IP addr) 0.0.0.0으로 일치하게 됩니다.

즉 모든 주소에 일치하게 됩니다. 따라서 해당 행의 게이트웨이 항목에 인터넷으로 나가는 라우터를 등록하면 다른 행에 해당되는 항목이 없는 패킷을 해당 게이트웨이로 중계합니다.

따라서 0.0.0.0 넷 마스크에 등록된 게이트웨이를 `기본 게이트웨이`라고 합니다.

이를 통해 중계 대상이 분명하지 않은 사태도 방지할 수 있습니다.

<br>

### 6. 패킷은 유효 기간이 있다

IP 헤더의 필드에 TTL이 존재하는데 패킷의 생존 기간을 나타냅니다.

라우터는 중계 대상을 찾아내고 패킷을 출력측의 포트로 옮기고 TTL을 갱신하는데 해당 값이 0이된다면 패킷의 수명이 다한것으로 간주합니다.

이는 패킷이 동일한 경로를 순환하는것을 막기 위함 입니다.

값은 64 혹은 128인데 라우터의 수는 지구 반대편까지 많아봐야 몇십개이기 때문입니다.

<br>

### 7. 큰 패킷은 조각 나누기 기능으로 분할한다

라우터의 포트 부분은 여러 통신 기술을 가질 수 있습니다.

이는 출력 포트측의 최대 길이가 입력 측보다 작은 경우도 존재할 수 있다는 의미 입니다.

따라서 출력 포트측의 최대 길이보다 패킷이 크다면 `fragmentation`을 이용해 패킷을 분할하여 중계합니다.

- 출력측 MTU 조사함
- 패킷의 크기와 비교하여 출력측 MTU가 더 작다면 분할, 아니라면 분할하지 않음
- IP 플래그 필드가 분할 불가라면 패킷을 폐기하고 ICMP 메시지로 송신처에 통지함

- **의문점**
    - TCP 프로토콜을 이용했을때, IP가 fragmentation했을때 3개의 조각으로 나뉜다면 TCP 헤더는 첫번째 조각에만 포함되는게 맞나? → TCP헤더

<br>

### 8. 라우터의 송신 동작은 컴퓨터와 같다

송신 전의 일이 끝나면 패킷의 송신 동작으로 넘어 가는데 이는 출력 측의 포트에 따라 다릅니다. (포트의 통신 기술 따라)

포트가 이더넷이라면 송신 동작은 이더넷의 규칙에 규정되어 있으므로 해당 규칙을 통해 패킷을 완성 시킵니다.

- 이후 라우팅 테이블의 `게이트웨이` 항목에서 패킷을 건네줄 상대를 판단합니다.
- **게이트웨이 항목에 IP 주소가 쓰여 있다면 해당 IP 주소로 패킷을 건네줍니다.**
- **게이트웨이 항목이 비어있다면 IP 헤더의 수신처 IP 주소가 건네줄 상대가 됩니다. (도착지?)**
- IP 주소가 결정되면 ARP를 이용해 MAC 주소를 조사하고 수신처 MAC 주소로 설정합니다.

이더넷이라 가정했으므로 다음으로 스위칭 허브 → 다음 라우터 ~~~ 진행되면서 최종 목적지에 도착합니다.

<br>

### 9. 라우터와 스위칭 허브의 관계

이더넷의 패킷 데이터 부분에 IP의 패킷을 넣고, IP 패킷의 데이터 부분에 TCP(혹은 다른것) 패킷을 넣는다고 표현하는 것이 원래의 개념에 가까움

IP구조는 스스로 패킷을 운반하는 수단이 없음 → 이더넷에 의뢰함

이더넷은 데이터를 분석하지 않음 → 하위 IP 구조에 의뢰

- 라우터는 IP의 개념에 기초하여 만들어졌음
- 스위칭 허브는 이더넷에 기초하여 만들어졌음

요즘 나오는 공유기들은 라우터와 스위칭 허브가 합쳐져 있는 경우가 많습니다.

**결국 라우터는 다음 라우터에 패킷을 운반하는 것이 주 목적이고, 스위칭 허브는 다음 라우터까지 도달하기 위해 패킷을 운반한다고 생각할 수 있습니다.**

(이더넷이 아니라 무선LAN, 통신 회선 등 다양한 기술이 존재하지만, 해당 통신 기술에 의뢰만 하면 패킷을 운반해줍니다.)

IP의 큰 특징은 다양한 통신 기술에 의뢰해 패킷을 운반할 수 있다는 점입니다. (서로 책임을 지지 않으므로)

<br><br>

## ✅ 04 라우터의 부가 기능

### 1. 주소 변환으로 IP 주소를 효율적으로 이용한다

- 기존 IP 주소는 모두 고유했지만, 인터넷 사용량이 증가하면서 금방 고갈될 것을 알게됨
- 따라서 서로 다른 네트워크에선 동일한 주소를 사용할 수 있고 **(private address)** 이전의 고유한 주소를 글로벌 주소로 사용합니다.
    
    
    | RFC1918 이름 | IP 주소 범위 | 주소 개수 | https://ko.wikipedia.org/wiki/%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC_%ED%81%B4%EB%9E%98%EC%8A%A4 내용 | 최대 https://ko.wikipedia.org/wiki/%EC%82%AC%EC%9D%B4%EB%8D%94_(%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%82%B9) 블록 (서브넷 마스크) | 호스트 ID 크기 |
    | --- | --- | --- | --- | --- | --- |
    | 24비트 블록 | 10.0.0.0 – 10.255.255.255 | 16,777,216 | 클래스 A 하나 | 10.0.0.0/8 (255.0.0.0) | 24 비트 |
    | 20비트 블록 | 172.16.0.0 – 172.31.255.255 | 1,048,576 | 16개의 인접 클래스 B | 172.16.0.0/12 (255.240.0.0) | 20 비트 |
    | 16비트 블록 | 192.168.0.0 – 192.168.255.255 | 65,536 | 256개의 인접 클래스 C | 192.168.0.0/16 (255.255.0.0) | 16 비트 |

각 네트워크 안에서 사용하는 프라이빗 주소는 서로 다른 네트워크에서 동일해도 상관이 없고, 인터넷에 공개되는 공개용 서버쪽에는 글로벌 주소를 할당하여 인터넷과 통신하도록 합니다.

![image](https://github.com/young0264/network_study/assets/66772624/faab84bb-f0da-4aac-b5aa-a50a6471093c)

<br>

### 2. 주소 변환의 기본 동작

패킷을 중계할 때 IP 헤더에 기재도니 IP 주소와 포트 번호를 바꿔 씀

| 글로벌 주소 | 포트 번호 | 프라이비트 주소 | 포트 번호 |
| --- | --- | --- | --- |
| 198.18.8.31 | 5436 | 10.10.1.1 | 1025 |
| 198.18.8.31 | 5437 | 10.10.1.2 | 1025 |
| 198.18.8.31 | 5438 | 10.10.1.3 | 2538 |
| ... | ... | ... | ... |

위와 같이 프라이빗 주소에 대응되는 글로벌 주소에 포트번호를 달리해 대응하여 대응표에 작성합니다.

패킷을 주고받을때 대응표에서 프라이빗 주소와 글로벌 주소의 대응관계를 조사하여 주소와 포트번호를 바꿔 중계하면 사내 영역의 여러 기기에 접근할 수 있습니다.

이후 인터넷 접속 동작이 끝나면 대응표에 등록한 것을 삭제합니다.

### 3. 포트 번호를 바꿔쓰는 이유

프라이빗 번호와 글로벌 주소를 1:1로 대응하면 주소 변환의 의미가 없습니다. → 프라이빗 주소수만큼 글로벌 주소가 비례하여 늘어나므로

포트 번호는 16비트 수치이므로 수만개의 값을 취하는데, 이는 1개의 글로벌 주소가 수만개의 프라이빗 주소와 대응시킬 수 있다는 의미 입니다.

<br>

### 4. 인터넷에서 회사로 액세스한다

- **사내 → 인터넷 방향으로의 패킷 중계**
    
    대응표에 프라이빗 주소, 포트 번호가 등록되어 있지 않아도 패킷을 중계할 수 있음(글로벌 주소는 알고, 프라이빗 주소도 앎 따라서 포트 번호만 임의로 정하면 되므로)
    
- **인터넷 → 사내 방향으로의 패킷 중계**
    
    대응표에 등록되어 있지 않다면 중계할 수 없음 → 주소 변환 장치가 어떤 프라이빗 주소로 전달해야 할지 판단할 수 없기 때문
    

위와 같은 효과 덕분에 부정 침입을 방지할 수 있습니다.

또한 필요하다면 주소 변환 장치 대응표에 수동으로 등록할 수 있습니다.

<br>

### 5. 라우터의 패킷 필터링 기능

패킷 필터링 기능은 라우터의 중요한 부가 기능 중 하나입니다. 패킷을 중계 할때 MAC 헤더, IP헤더, TCP 헤더에 기록되어 있는 내용을 조사하여 사전 설정 조건에 합치어 해킷을 중계 혹은 폐기할지를 결정합니다.

방화벽에 많이 사용되며, 자세한 내용은 뒷 장에서 설명 합니다.
